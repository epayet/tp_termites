<html>
<header>
    <link rel="stylesheet" type="text/css" href="style.css">
    <!--Agent-->
	<script type="text/javascript" src="src/agent/agent.js"></script>
    <script type="text/javascript" src="src/agent/termite.js"></script>
    <script type="text/javascript" src="src/agent/wood_heap.js"></script>
    <script type="text/javascript" src="src/agent/wall.js"></script>
    <script type="text/javascript" src="src/agent/grid_debug.js"></script>
    <!--World-->
    <script type="text/javascript" src="src/world/world.js"></script>
    <script type="text/javascript" src="src/world/world_solver.js"></script>
    <!--Expert system-->
    <script type="text/javascript" src="src/expert_system/expert_system.js"></script>
    <script type="text/javascript" src="src/expert_system/engine.js"></script>
    <script type="text/javascript" src="src/expert_system/fact.js"></script>
    <script type="text/javascript" src="src/expert_system/rule.js"></script>
    <!--Math-->
    <script type="text/javascript" src="src/math/vector.js"></script>
    <!--Misc-->
    <script type="text/javascript" src="src/info/wood_info.js"></script>
    <script type="text/javascript" src="src/info/grid_info.js"></script>
    <!--Lib-->
    <script type="text/javascript" src="src/lib/astar.js"></script>

    <script language="javascript">
    var NB_TERMITES = 20;
    var NB_WOODHEAPS = 5;
    var NB_WALLS = 0;
    var NODE_SIZE = {
        width: 16,
        height: 16
    };

    DEBUG = {
        play: true,
        toggle_grid: true,
        useGrid : true
    };

	var world = null;
	var canvasElement = null;
	var canvasContext = null;

	var mainLoop = null;
	var lastUpdate = Date.now();
	var dt = 0;

    HEAPS = [];
    WALLS = [];

	function updateTime() {
		var now = Date.now();
    	dt = now - lastUpdate;
    	lastUpdate = now;
	}

	function update() {
		updateTime();
		world.update(dt);
		canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
		world.draw(canvasContext);
	}

	function init() {
		canvasElement = document.getElementById("canvas");
		canvasContext = this.canvasElement.getContext("2d");

		world = new World(canvasElement.width, canvasElement.height);
        document.getElementById('agent').value = NB_TERMITES;
        document.getElementById('heap').value = NB_WOODHEAPS;
        document.getElementById('wall').value = NB_WALLS;
        document.getElementById('width').value = NODE_SIZE.width;
        document.getElementById('height').value = NODE_SIZE.height;

		for(var i = 0; i < NB_WOODHEAPS; i ++) {
			var woodHeap = new WoodHeap();
			world.addAgent(woodHeap);
			woodHeap.moveTo(	canvasElement.width * Math.random(),
								canvasElement.height * Math.random());
            HEAPS.push(woodHeap);
		}

		for(var i = 0; i < NB_WALLS; i++) {
			var wall = new Wall();
			world.addAgent(wall);
			wall.moveTo(	canvasElement.width * Math.random(),
							canvasElement.height * Math.random());
            WALLS.push(wall);
		}

		/*var solver = new WorldSolver(world);
		solver.solve();*/

		//world.draw(canvasContext);

		for(var i = 0; i < NB_TERMITES; i ++) {
            var isDebugTermite = false;
            if(i == 0)
                isDebugTermite = true;
            var options = {
                worldSize: {
                    width: canvasElement.width,
                    height: canvasElement.height
                },
                nodeSize: NODE_SIZE,
                isDebugTermite: isDebugTermite,
                useGrid : DEBUG.useGrid
            };
			var termite = new Termite(options);
			world.addAgent(termite);
			termite.moveTo(	canvasElement.width * Math.random(),
							canvasElement.height * Math.random());
            if(isDebugTermite && DEBUG.useGrid)
                world.addAgent(new GridDebug({
                    gridInfo: termite.gridInfo,
                    nodeSize : NODE_SIZE,
                    termiteTargets: termite.nodesTarget
                }));
		}

		var fps = 60;
		mainLoop = setInterval(update, 1000 / fps);
		//update();
	}

    function setValue(){
        NB_TERMITES = document.getElementById('agent').value;
        NB_WOODHEAPS = document.getElementById('heap').value;
        NB_WALLS = document.getElementById('wall').value;
        NODE_SIZE.width = document.getElementById('width').value;
        NODE_SIZE.height = document.getElementById('height').value;
        init();
    }
	</script>
</header>
<body onload="init()">

    <div id="container">
        <div id="main">
            <canvas id="canvas" width="600" height="600" style="background-color:#eee; display:inline-block"></canvas>
        </div>

        <div id="misc">
            <table>
                <tr>
                    <td><button onclick="DEBUG.play = !DEBUG.play">Stop/Play</button></td>
                    <td><button onclick="DEBUG.toggle_grid = !DEBUG.toggle_grid">Toggle grid</button></td>
                </tr>
                <tr>
                    <td><label>Nombre de termites :</label></td>
                    <td><input type="text" id="agent"></td>
                </tr>
                <tr>
                    <td><label>Nombre de tas de bois :</label></td>
                    <td><input type="text" id="heap"></td>
                </tr>
                <tr>
                    <td><label>Nombre de wall :</label></td>
                    <td><input type="text" id="wall"></td>
                </tr>
                <tr>
                    <td> <label>Taille de node :</label><br></td>
                    <td>
                        width :<input type="text" id="width"><br>
                        height :<input type="text" id="height">
                    </td>
                </tr>
                <tr>
                    <td> <button onclick="setValue()">Valider</button></td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>